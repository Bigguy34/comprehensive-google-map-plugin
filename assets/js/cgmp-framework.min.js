jQuery.GoogleMapOrchestrator=function(a,j){if(typeof google=="undefined"||!google){Logger.fatal("We do not have reference to Google API. Aborting..");return false}jQuery.extend(this,jQuery.GoogleMapOrchestrator.defaultOptions);jQuery.GoogleMapOrchestrator.AnimationType={DROP:0,BOUNCE:1};jQuery.GoogleMapOrchestrator.LayerType={TRAFFIC:0,BIKE:1,KML:2,PANORAMIO:3};jQuery.GoogleMapOrchestrator.ControlType={PAN:0,ZOOM:1,SCALE:2,STREETVIEW:3,MAPTYPE:4};var j=j||{};var h=j.placeHolder||"map";var i=j.zoom||16;var c=j.mapType||google.maps.MapTypeId.ROADMAP;var d=j.bubbleAutoPan||"true";var g=a;g.setOptions({zoom:i,mapTypeId:c,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}});var b=new jQuery.LayerBuilder(g);var e=new jQuery.MarkerBuilder(g,d);google.maps.event.addListener(g,"click",function(){e.shiftMapToOriginalZoomAndLocation()});function f(){if(typeof g=="undefined"||!g||g==null){Logger.fatal("We do not have instance of the Google API object. Aborting..");return false}return true}this.buildAddressMarkers=function(k){if(!f()){return false}e.buildAddressMarkers(k)};this.buildLayer=function(m,k,l){if(!f()){return false}switch(m){case jQuery.GoogleMapOrchestrator.LayerType.TRAFFIC:b.buildTrafficLayer();break;case jQuery.GoogleMapOrchestrator.LayerType.BIKE:b.buildBikeLayer();break;case jQuery.GoogleMapOrchestrator.LayerType.PANORAMIO:if(l!=null&&l!=""){Logger.info("Going to filter Panoramio images by "+l);b.buildPanoramioLayer(l)}else{b.buildPanoramioLayer()}break;case jQuery.GoogleMapOrchestrator.LayerType.KML:if(k==null||k==""){Logger.error("KML URL must be passed for the KML Layer. Aborting..");return false}b.buildKmlLayer(k);break;default:Logger.warn("Unknown layer type: "+m)}};this.switchMapControl=function(l,k){if(!f()){return false}switch(k){case jQuery.GoogleMapOrchestrator.ControlType.MAPTYPE:g.setOptions({mapTypeControl:l});break;case jQuery.GoogleMapOrchestrator.ControlType.PAN:g.setOptions({panControl:l});break;case jQuery.GoogleMapOrchestrator.ControlType.ZOOM:g.setOptions({zoomControl:l});break;case jQuery.GoogleMapOrchestrator.ControlType.SCALE:g.setOptions({scaleControl:l});break;case jQuery.GoogleMapOrchestrator.ControlType.STREETVIEW:g.setOptions({streetViewControl:l});break;default:Logger.warn("Unknown map control type: "+k)}}};jQuery.Utils=function(){jQuery.extend(this,jQuery.Utils.defaultOptions);var b=/^([a-zA-Z0-9?(/\-.,\s{1,})]+)$/;var a=/^([0-9?(\-.,\s{1,})]+)$/;this.isNumeric=function(c){return a.test(c)};this.isAlphaNumeric=function(c){return b.test(c)}};jQuery.LayerBuilder=function(a){jQuery.extend(this,jQuery.LayerBuilder.defaultOptions);var b=a;this.buildTrafficLayer=function(){var c=new google.maps.TrafficLayer();c.setMap(b)};this.buildBikeLayer=function(){var c=new google.maps.BicyclingLayer();c.setMap(b)};this.buildPanoramioLayer=function(d){if(typeof google.maps.panoramio=="undefined"||!google.maps.panoramio||google.maps.panoramio==null){Logger.error("We cannot access Panoramio library. Aborting..");return false}var c=new google.maps.panoramio.PanoramioLayer();if(c){if(d!=null&&d!=""){c.setUserId(d)}c.setMap(b)}else{Logger.error("Could not instantiate Panoramio object. Aborting..")}};this.buildKmlLayer=function(c){if(c.toLowerCase().indexOf("http")<0){Logger.error("KML URL must start with HTTP(S). Aborting..");return false}var d=new google.maps.KmlLayer(c);d.setMap(b)}};jQuery.MarkerBuilder=function(t,c){jQuery.extend(this,jQuery.MarkerBuilder.defaultOptions);var J=[];var z=[];var E=null;var I=false;var e=t;var f=null;var c=c;var p=null;var g=null;var k=5;var u=e.getDiv().id;var K=new jQuery.Utils();var l=new google.maps.Geocoder();var y=new google.maps.LatLngBounds();var A=new google.maps.InfoWindow();var w=new google.maps.StreetViewService();var r={draggable:true};var q=new google.maps.DirectionsRenderer(r);q.setPanel(document.getElementById("rendered-directions-placeholder-"+u));var D=new google.maps.DirectionsService();function B(){if(p!=null){if(e.setCenter()!=p.getCenter()){Logger.info("Panning map back to its original bounds center: "+p.getCenter()+" and updated zoom: "+k);e.setCenter(p.getCenter());e.setZoom(k)}}else{if(g!=null){Logger.info("Panning map back to its original center: "+g+" and updated zoom: "+k);e.setCenter(g);e.setZoom(k)}}}function x(L){jQuery(L+" input#a_address").val("");jQuery(L+" input#b_address").val("");jQuery(L+" input#a_address").removeClass("d_error");jQuery(L+" input#b_address").removeClass("d_error")}function a(M){var O=d(M.content);var L="div#direction-controls-placeholder-"+u;var N=jQuery("div#rendered-directions-placeholder-"+u);google.maps.event.addListener(M,"click",function(){x(L);jQuery(L).fadeOut();q.setMap(null);N.html("");N.hide();jQuery(L+" button#print_sub").hide();A.setContent(O.bubbleContent);A.setOptions({disableAutoPan:c=="true"?false:true});A.open(t,this)});s(M,O,L);o(M,O,L,N)}function o(M,P,L,O){var Q="div#bubble-"+P.bubbleHolderId;var N=M.content.split("<br />Lat/Long: ");N[0]=N[0].replace("Lat/Long: ","");jQuery(Q+" a.dirToHereTrigger").live("click",function(){var R=this.id;if(R=="toHere-"+P.bubbleHolderId){jQuery(L).fadeIn();jQuery(L+" input#a_address").val("");jQuery(L+" input#b_address").val(N[0]);jQuery(L+" input#radio_miles").attr("checked","checked")}});jQuery(Q+" a.dirFromHereTrigger").live("click",function(){var R=this.id;if(R=="fromHere-"+P.bubbleHolderId){jQuery(L).fadeIn();jQuery(L+" input#a_address").val(N[0]);jQuery(L+" input#b_address").val("");jQuery(L+" input#radio_miles").attr("checked","checked")}});jQuery(L+" div.d_close-wrapper").live("click",function(R){x(L);jQuery(this).parent().fadeOut();q.setMap(null);O.html("");O.hide();jQuery(L+" button#print_sub").hide();B();return false})}function s(M,N,L){w.getPanoramaByLocation(M.position,50,function(P,O){if(O===google.maps.StreetViewStatus.OK){jQuery("a#trigger-"+N.bubbleHolderId).live("click",function(){var R={navigationControl:true,enableCloseButton:true,addressControl:false,linksControl:true,scrollwheel:false,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM},position:M.position,pov:{heading:165,pitch:0,zoom:1}};var Q=new google.maps.StreetViewPanorama(document.getElementById("bubble-"+N.bubbleHolderId),R);Q.setVisible(true);google.maps.event.addListener(A,"closeclick",function(){x(L);jQuery(L).fadeOut();if(Q!=null){Q.unbind("position");Q.setVisible(false)}Q=null});google.maps.event.addListener(Q,"closeclick",function(){if(Q!=null){Q.unbind("position");Q.setVisible(false);jQuery("div#bubble-"+N.bubbleHolderId).css("background","none")}Q=null})})}else{Logger.warn("There is not street view available for this marker location: "+M.position+" status: "+O);jQuery("a#trigger-"+N.bubbleHolderId).live("click",function(Q){Q.preventDefault()});jQuery("a#trigger-"+N.bubbleHolderId).attr("style","text-decoration: none !important; color: #ddd !important");google.maps.event.addListener(A,"domready",function(){jQuery("a#trigger-"+N.bubbleHolderId).removeAttr("href");jQuery("a#trigger-"+N.bubbleHolderId).attr("style","text-decoration: none !important; color: #ddd !important")})}})}function i(){var L="div#direction-controls-placeholder-"+u;var M=jQuery("div#rendered-directions-placeholder-"+u);jQuery(L+" a#reverse-btn").live("click",function(P){var O=jQuery(L+" input#a_address").val();var N=jQuery(L+" input#b_address").val();jQuery(L+" input#a_address").val(N);jQuery(L+" input#b_address").val(O);return false});jQuery(L+" a#d_options_show").live("click",function(){jQuery(L+" a#d_options_hide").show();jQuery(L+" a#d_options_show").hide();jQuery(L+" div#d_options").show();return false});jQuery(L+" a#d_options_hide").live("click",function(){jQuery(L+" a#d_options_hide").hide();jQuery(L+" a#d_options_show").show();jQuery(L+" div#d_options").hide();jQuery(L+" input#avoid_hway").removeAttr("checked");jQuery(L+" input#avoid_tolls").removeAttr("checked");jQuery(L+" input#radio_km").removeAttr("checked");jQuery(L+" input#radio_miles").attr("checked","checked");return false});jQuery(L+" button#d_sub").live("click",function(){var N=jQuery(L+" input#a_address").val();var S=jQuery(L+" input#b_address").val();var T=false;if(N==null||N==""){jQuery(L+" input#a_address").addClass("d_error");T=true}if(S==null||S==""){jQuery(L+" input#b_address").addClass("d_error");T=true}if(!T){jQuery(L+" button#d_sub").attr("disabled","disabled").html("Please wait..");var O=google.maps.DirectionsTravelMode.DRIVING;if(jQuery(L+" a#dir_w_btn").hasClass("selected")){O=google.maps.DirectionsTravelMode.WALKING}var V=jQuery(L+" input#avoid_hway").is(":checked");var Q=jQuery(L+" input#avoid_tolls").is(":checked");var R=jQuery(L+" input#radio_miles").is(":checked");var P=google.maps.DirectionsUnitSystem.METRIC;var U={origin:N,destination:S,travelMode:O,provideRouteAlternatives:true};if(V){U.avoidHighways=true}if(Q){U.avoidTolls=true}if(R){U.unitSystem=google.maps.DirectionsUnitSystem.IMPERIAL}else{U.unitSystem=google.maps.DirectionsUnitSystem.METRIC}D.route(U,function(X,W){if(W==google.maps.DirectionsStatus.OK){M.html("");M.show();q.setMap(e);q.setDirections(X);jQuery(L+" button#d_sub").removeAttr("disabled").html("Get directions");jQuery(L+" button#print_sub").fadeIn();A.close()}else{Logger.error('Could not route directions from "'+N+'" to "'+S+'", got result from Google: '+W);M.html("<span style='font-size: 12px; font-weight: bold; color: red'>Could not route directions from<br />'"+N+"' to<br />'"+S+"'<br />Got result from Google: ["+W+"]</span>");jQuery(L+" button#print_sub").hide();jQuery(L+" button#d_sub").removeAttr("disabled").html("Get directions")}})}});jQuery(L+" button#print_sub").live("click",function(){var Q=jQuery(L+" input#a_address").val();var O=jQuery(L+" input#b_address").val();var P="d";if(jQuery(L+" a#dir_w_btn").hasClass("selected")){P="w"}var N="http://maps.google.com/?saddr="+Q+"&daddr="+O+"&dirflg="+P+"&pw=2";var R=jQuery(L+" input#radio_miles").is(":checked");if(R){N+="&doflg=ptm"}window.open(N);return false});jQuery(L+" input#a_address").live("change",function(){jQuery(L+" input#a_address").removeClass("d_error");return false});jQuery(L+" input#b_address").live("change",function(){jQuery(L+" input#b_address").removeClass("d_error");return false});jQuery(L+" input#a_address").live("focus",function(){jQuery(L+" input#a_address").removeClass("d_error");return false});jQuery(L+" input#b_address").live("focus",function(){jQuery(L+" input#b_address").removeClass("d_error");return false});jQuery(L+" .kd-button").live("click",function(){var N=this.id;if(N=="dir_d_btn"){if(jQuery(L+" a#dir_d_btn").hasClass("selected")){Logger.warn("Driving travel mode is already selected")}else{jQuery(L+" a#dir_d_btn").addClass("selected");jQuery(L+" a#dir_w_btn").removeClass("selected")}}else{if(N=="dir_w_btn"){if(jQuery(L+" a#dir_w_btn").hasClass("selected")){Logger.warn("Walking travel mode is already selected")}else{jQuery(L+" a#dir_w_btn").addClass("selected");jQuery(L+" a#dir_d_btn").removeClass("selected")}}}return false})}function d(O){var N=[];var M=Math.floor(Math.random()*111111);M=M+"-"+u;var L="<div id='bubble-"+M+"' style='height: 130px !important; width: 300px !important;' class='bubble-content'>";L+="<h4>Address:</h4>";L+="<p style='text-align: left'>"+O+"</p>";L+="<hr />";L+="<p style='text-align: left'>Directions: <a id='toHere-"+M+"' class='dirToHereTrigger' href='javascript:void(0);'>To here</a> - <a id='fromHere-"+M+"' class='dirFromHereTrigger' href='javascript:void(0);'>From here</a> | <a id='trigger-"+M+"' class='streetViewTrigger' href='javascript:void(0);'>Street View</a></p>";L+="</div>";return{bubbleHolderId:M,bubbleContent:L}}function j(){f=f.replace(new RegExp("'","g"),"");Logger.info("Current CSV with locations: "+f);var L=f.split("|");Logger.info("Exploded CSV into locations: "+L);for(var M=0;M<L.length;M++){var N=L[M];if(N!=null&&N!=""){N=N.replace(/^\s+|\s+$/g,"");if(N==""){Logger.warn("Given extra marker address is empty");continue}b(N,(M+1))}}}function b(N,L){var M=N.split(CGMPGlobal.sep);if(K.isNumeric(M[0])){h(M[0],L,M[1])}else{if(K.isAlphaNumeric(M[0])){G(M[0],L,M[1])}else{G(M[0],L,M[1]);Logger.warn("Unknown type of geo destination in regexp: "+M[0]+", fallingback to store it as an address")}}}function G(M,N,L){Logger.info("Storing address: "+M+" for marker-to-be");z.push({address:M,animation:google.maps.Animation.DROP,zIndex:N,markerIcon:L})}function h(M,R,L){if(M==null||!M){Logger.warn("Given GEO point containing Lat/Long is NULL");return false}var P=M;if(!(P instanceof google.maps.LatLng)){if(M.indexOf(",")!=-1){var O=M.split(",",4);if(O==null||O.length!=2){Logger.warn("Exploded lat/long array is NULL or does not have length of two");return false}if(O[0]==null||O[1]==null){Logger.warn("Lat or Long are NULL");return false}O[0]=O[0].replace(/^\s\s*/,"").replace(/\s\s*$/,"");O[1]=O[1].replace(/^\s\s*/,"").replace(/\s\s*$/,"");if(O[0]==""||O[1]==""){Logger.warn("Lat or Long are empty string");return false}var Q=parseFloat(O[0]);var N=parseFloat(O[1]);P=new google.maps.LatLng(Q,N)}}G(P,R,L)}this.buildAddressMarkers=function(L){f=L;j();C()};this.shiftMapToOriginalZoomAndLocation=function(){B()};function C(){E=null;if(z.length>0){var M=z.shift();if(M.address instanceof google.maps.LatLng){H(M)}else{var L={address:M.address};l.geocode(L,function(O,N){n(O,N,M)})}}else{m()}}function m(){if(J.length>1){jQuery.each(J,function(M,L){if(!y.contains(L.position)){y.extend(L.position)}});p=y;e.fitBounds(y);k=e.getZoom()}else{if(J.length==1){e.setCenter(J[0].position);k=e.getZoom()}}}function H(M){var L=M.address;M.address=v(M,L);F(L,M);E=setTimeout(function(){C()},330)}function v(N,M){if(N.zIndex==1){g=M;Logger.info("Storing original map center ["+g+"]")}var O=M.lat();O=parseFloat(O);O=O.toFixed(5);var L=M.lng();L=parseFloat(L);L=L.toFixed(5);return"Lat/Long: "+O+", "+L}function n(O,L,N){if(L==google.maps.GeocoderStatus.OK){var M=O[0].geometry.location;N.address=O[0].formatted_address+"<br />"+v(N,M);F(M,N);E=setTimeout(function(){C()},330)}else{if(L==google.maps.GeocoderStatus.OVER_QUERY_LIMIT){m();z.push(N);E=setTimeout(function(){C()},3000)}else{if(L==google.maps.GeocoderStatus.ZERO_RESULTS){Logger.warn("Got ZERO results for "+N.address+" while having "+J.length+" markers")}}}}function F(M,P){var N=new google.maps.Marker({position:M,title:P.address.replace("<br />"," :: "),content:P.address,zIndex:(P.zIndex+1000),map:e});if(N){if(P.markerIcon){var L=P.markerIcon;N.setIcon(CGMPGlobal.customMarkersUri+L);var S=null;var Q=["1-default.png","2-default.png"];var O=["4-default.png","5-default.png","6-default.png","7-default.png"];if(jQuery.inArray(L,Q)!=-1){S=new google.maps.MarkerImage("http://maps.google.com/mapfiles/ms/icons/msmarker.shadow.png",new google.maps.Size(59,32),new google.maps.Point(0,0),new google.maps.Point(16,33))}else{if(jQuery.inArray(L,O)!=-1){S=new google.maps.MarkerImage("http://maps.google.com/mapfiles/ms/icons/msmarker.shadow.png",new google.maps.Size(59,32),new google.maps.Point(0,0),new google.maps.Point(21,34))}else{if(L.indexOf("3-default")!=-1){S=new google.maps.MarkerImage("http://code.google.com/apis/maps/documentation/javascript/examples/images/beachflag_shadow.png",new google.maps.Size(37,32),new google.maps.Point(0,0),new google.maps.Point(10,33))}else{S=new google.maps.MarkerImage(CGMPGlobal.customMarkersUri+"shadow.png",new google.maps.Size(68,37),new google.maps.Point(0,0),new google.maps.Point(32,38))}}}var R=S.url.split("/");Logger.info("Setting shadow file ["+R[R.length-1]+"] for icon ["+L+"]");N.setShadow(S)}if(P.zIndex==0&&P.animation==google.maps.Animation.BOUNCE){N.setAnimation(google.maps.Animation.BOUNCE)}a(N);if(!I){i();I=true}J.push(N)}}};jQuery.OrchestratorHub=function(){jQuery.extend(this,jQuery.OrchestratorHub.defaultOptions);var a=[];this.getOrcs=function(){return a};this.push=function(b){a.push(b)};this.getOrc=function(b){var c={};jQuery.map(jQuery(a),function(d){if(d.mapId==b){c=d.orchestrator}});return c}};var Logger={info:function(a){var b="Info :: "+a;this.print(b)},warn:function(a){var b="Warning :: "+a;this.print(b)},error:function(a){var b="Error :: "+a;this.print(b)},fatal:function(a){var b="Fatal :: "+a;this.print(b)},print:function(a){if(jQuery.browser.msie){}else{if(jQuery.browser.mozilla&&jQuery.browser.version>="3.0"){console.log(a)}}}};var orcHolder=new jQuery.OrchestratorHub();