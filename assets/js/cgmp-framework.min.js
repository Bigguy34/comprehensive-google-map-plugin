var jQueryCgmp=jQuery.noConflict();jQueryCgmp.GoogleMapOrchestrator=function(a,j){if(typeof google=="undefined"||!google){Logger.fatal("We do not have reference to Google API. Aborting..");return false}jQueryCgmp.extend(this,jQueryCgmp.GoogleMapOrchestrator.defaultOptions);jQueryCgmp.GoogleMapOrchestrator.AnimationType={DROP:0,BOUNCE:1};jQueryCgmp.GoogleMapOrchestrator.LayerType={TRAFFIC:0,BIKE:1,KML:2,PANORAMIO:3};jQueryCgmp.GoogleMapOrchestrator.ControlType={PAN:0,ZOOM:1,SCALE:2,STREETVIEW:3,MAPTYPE:4,SCROLLWHEEL:5};var j=j||{};var h=j.placeHolder||"map";var i=j.zoom||16;var c=j.mapType||google.maps.MapTypeId.ROADMAP;var d=j.bubbleAutoPan||"true";var g=a;g.setOptions({zoom:i,mapTypeId:c,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}});var b=new jQueryCgmp.LayerBuilder(g);var e=new jQueryCgmp.MarkerBuilder(g,d);this.isBuildAddressMarkersCalled=function(){return e.isBuildAddressMarkersCalled()};google.maps.event.addListener(g,"click",function(){e.shiftMapToOriginalZoomAndLocation()});function f(){if(typeof g=="undefined"||!g||g==null){Logger.fatal("We do not have instance of the Google API object. Aborting..");return false}return true}this.buildAddressMarkers=function(m,k,l){if(!f()){return false}e.buildAddressMarkers(m,k,l)};this.buildLayer=function(m,k,l){if(!f()){return false}switch(m){case jQueryCgmp.GoogleMapOrchestrator.LayerType.TRAFFIC:b.buildTrafficLayer();break;case jQueryCgmp.GoogleMapOrchestrator.LayerType.BIKE:b.buildBikeLayer();break;case jQueryCgmp.GoogleMapOrchestrator.LayerType.PANORAMIO:if(l!=null&&l!=""){Logger.info("Going to filter Panoramio images by "+l);b.buildPanoramioLayer(l)}else{b.buildPanoramioLayer()}break;case jQueryCgmp.GoogleMapOrchestrator.LayerType.KML:if(k==null||k==""){Logger.error("KML URL must be passed for the KML Layer. Aborting..");return false}b.buildKmlLayer(k);break;default:Logger.warn("Unknown layer type: "+m)}};this.switchMapControl=function(l,k){if(!f()){return false}switch(k){case jQueryCgmp.GoogleMapOrchestrator.ControlType.SCROLLWHEEL:g.setOptions({scrollwheel:l});break;case jQueryCgmp.GoogleMapOrchestrator.ControlType.MAPTYPE:g.setOptions({mapTypeControl:l});break;case jQueryCgmp.GoogleMapOrchestrator.ControlType.PAN:g.setOptions({panControl:l});break;case jQueryCgmp.GoogleMapOrchestrator.ControlType.ZOOM:g.setOptions({zoomControl:l});break;case jQueryCgmp.GoogleMapOrchestrator.ControlType.SCALE:g.setOptions({scaleControl:l});break;case jQueryCgmp.GoogleMapOrchestrator.ControlType.STREETVIEW:g.setOptions({streetViewControl:l});break;default:Logger.warn("Unknown map control type: "+k)}}};jQueryCgmp.Utils=function(){jQueryCgmp.extend(this,jQueryCgmp.Utils.defaultOptions);var b=/^([a-zA-Z0-9?(/\-.,\s{1,})]+)$/;var a=/^([0-9?(\-.,\s{1,})]+)$/;this.isNumeric=function(c){return a.test(c)};this.isAlphaNumeric=function(c){return b.test(c)}};jQueryCgmp.LayerBuilder=function(a){jQueryCgmp.extend(this,jQueryCgmp.LayerBuilder.defaultOptions);var b=a;this.buildTrafficLayer=function(){var c=new google.maps.TrafficLayer();c.setMap(b)};this.buildBikeLayer=function(){var c=new google.maps.BicyclingLayer();c.setMap(b)};this.buildPanoramioLayer=function(d){if(typeof google.maps.panoramio=="undefined"||!google.maps.panoramio||google.maps.panoramio==null){Logger.error("We cannot access Panoramio library. Aborting..");return false}var c=new google.maps.panoramio.PanoramioLayer();if(c){if(d!=null&&d!=""){c.setUserId(d)}c.setMap(b)}else{Logger.error("Could not instantiate Panoramio object. Aborting..")}};this.buildKmlLayer=function(c){if(c.toLowerCase().indexOf("http")<0){Logger.error("KML URL must start with HTTP(S). Aborting..");return false}var d=new google.maps.KmlLayer(c);d.setMap(b)}};jQueryCgmp.MarkerBuilder=function(v,d){jQueryCgmp.extend(this,jQueryCgmp.MarkerBuilder.defaultOptions);var M=[];var C=[];var z=[];var q=false;var H=null;var L=false;var f=v;var g=null;var d=d;var r=null;var h=null;var l=5;var w=f.getDiv().id;var N=new jQueryCgmp.Utils();var m=new google.maps.Geocoder();var B=new google.maps.LatLngBounds();var D=new google.maps.InfoWindow();var y=new google.maps.StreetViewService();var t={draggable:true};var s=new google.maps.DirectionsRenderer(t);s.setPanel(document.getElementById("rendered-directions-placeholder-"+w));var G=new google.maps.DirectionsService();function E(){if(r!=null){if(f.setCenter()!=r.getCenter()){Logger.info("Panning map back to its original bounds center: "+r.getCenter()+" and updated zoom: "+l);f.setCenter(r.getCenter());f.setZoom(l)}}else{if(h!=null){Logger.info("Panning map back to its original center: "+h+" and updated zoom: "+l);f.setCenter(h);f.setZoom(l)}}}function A(O){jQueryCgmp(O+" input#a_address").val("");jQueryCgmp(O+" input#b_address").val("");jQueryCgmp(O+" input#a_address").removeClass("d_error");jQueryCgmp(O+" input#b_address").removeClass("d_error")}function b(P,Q){var S=e(P.content,Q);var O="div#direction-controls-placeholder-"+w;var R=jQueryCgmp("div#rendered-directions-placeholder-"+w);google.maps.event.addListener(P,"click",function(){A(O);jQueryCgmp(O).fadeOut();s.setMap(null);R.html("");R.hide();jQueryCgmp(O+" button#print_sub").hide();D.setContent(S.bubbleContent);D.setOptions({disableAutoPan:d=="true"?false:true});D.open(v,this)});u(P,S,O);p(P,S,O,R)}function p(P,S,O,R){var T="div#bubble-"+S.bubbleHolderId;var Q=P.content.split("<br />Lat/Long: ");Q[0]=Q[0].replace("Lat/Long: ","");jQueryCgmp(T+" a.dirToHereTrigger").live("click",function(){var U=this.id;if(U=="toHere-"+S.bubbleHolderId){jQueryCgmp(O).fadeIn();jQueryCgmp(O+" input#a_address").val("");jQueryCgmp(O+" input#b_address").val(Q[0]);jQueryCgmp(O+" input#radio_miles").attr("checked","checked")}});jQueryCgmp(T+" a.dirFromHereTrigger").live("click",function(){var U=this.id;if(U=="fromHere-"+S.bubbleHolderId){jQueryCgmp(O).fadeIn();jQueryCgmp(O+" input#a_address").val(Q[0]);jQueryCgmp(O+" input#b_address").val("");jQueryCgmp(O+" input#radio_miles").attr("checked","checked")}});jQueryCgmp(O+" div.d_close-wrapper").live("click",function(U){A(O);jQueryCgmp(this).parent().fadeOut();s.setMap(null);R.html("");R.hide();jQueryCgmp(O+" button#print_sub").hide();E();return false})}function u(P,Q,O){y.getPanoramaByLocation(P.position,50,function(S,R){if(R===google.maps.StreetViewStatus.OK){jQueryCgmp("a#trigger-"+Q.bubbleHolderId).live("click",function(){var U={navigationControl:true,enableCloseButton:true,addressControl:false,linksControl:true,scrollwheel:false,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM},position:P.position,pov:{heading:165,pitch:0,zoom:1}};var T=new google.maps.StreetViewPanorama(document.getElementById("bubble-"+Q.bubbleHolderId),U);T.setVisible(true);google.maps.event.addListener(D,"closeclick",function(){A(O);jQueryCgmp(O).fadeOut();if(T!=null){T.unbind("position");T.setVisible(false)}T=null});google.maps.event.addListener(T,"closeclick",function(){if(T!=null){T.unbind("position");T.setVisible(false);jQueryCgmp("div#bubble-"+Q.bubbleHolderId).css("background","none")}T=null})})}else{Logger.warn("There is not street view available for this marker location: "+P.position+" status: "+R);jQueryCgmp("a#trigger-"+Q.bubbleHolderId).live("click",function(T){T.preventDefault()});jQueryCgmp("a#trigger-"+Q.bubbleHolderId).attr("style","text-decoration: none !important; color: #ddd !important");google.maps.event.addListener(D,"domready",function(){jQueryCgmp("a#trigger-"+Q.bubbleHolderId).removeAttr("href");jQueryCgmp("a#trigger-"+Q.bubbleHolderId).attr("style","text-decoration: none !important; color: #ddd !important")})}})}function j(){var O="div#direction-controls-placeholder-"+w;var P=jQueryCgmp("div#rendered-directions-placeholder-"+w);jQueryCgmp(O+" a#reverse-btn").live("click",function(S){var R=jQueryCgmp(O+" input#a_address").val();var Q=jQueryCgmp(O+" input#b_address").val();jQueryCgmp(O+" input#a_address").val(Q);jQueryCgmp(O+" input#b_address").val(R);return false});jQueryCgmp(O+" a#d_options_show").live("click",function(){jQueryCgmp(O+" a#d_options_hide").show();jQueryCgmp(O+" a#d_options_show").hide();jQueryCgmp(O+" div#d_options").show();return false});jQueryCgmp(O+" a#d_options_hide").live("click",function(){jQueryCgmp(O+" a#d_options_hide").hide();jQueryCgmp(O+" a#d_options_show").show();jQueryCgmp(O+" div#d_options").hide();jQueryCgmp(O+" input#avoid_hway").removeAttr("checked");jQueryCgmp(O+" input#avoid_tolls").removeAttr("checked");jQueryCgmp(O+" input#radio_km").removeAttr("checked");jQueryCgmp(O+" input#radio_miles").attr("checked","checked");return false});jQueryCgmp(O+" button#d_sub").live("click",function(){var Q=jQueryCgmp(O+" input#a_address").val();var V=jQueryCgmp(O+" input#b_address").val();var W=false;if(Q==null||Q==""){jQueryCgmp(O+" input#a_address").addClass("d_error");W=true}if(V==null||V==""){jQueryCgmp(O+" input#b_address").addClass("d_error");W=true}if(!W){jQueryCgmp(O+" button#d_sub").attr("disabled","disabled").html("Please wait..");var R=google.maps.DirectionsTravelMode.DRIVING;if(jQueryCgmp(O+" a#dir_w_btn").hasClass("selected")){R=google.maps.DirectionsTravelMode.WALKING}var Y=jQueryCgmp(O+" input#avoid_hway").is(":checked");var T=jQueryCgmp(O+" input#avoid_tolls").is(":checked");var U=jQueryCgmp(O+" input#radio_miles").is(":checked");var S=google.maps.DirectionsUnitSystem.METRIC;var X={origin:Q,destination:V,travelMode:R,provideRouteAlternatives:true};if(Y){X.avoidHighways=true}if(T){X.avoidTolls=true}if(U){X.unitSystem=google.maps.DirectionsUnitSystem.IMPERIAL}else{X.unitSystem=google.maps.DirectionsUnitSystem.METRIC}G.route(X,function(aa,Z){if(Z==google.maps.DirectionsStatus.OK){P.html("");P.show();s.setMap(f);s.setDirections(aa);jQueryCgmp(O+" button#d_sub").removeAttr("disabled").html("Get directions");jQueryCgmp(O+" button#print_sub").fadeIn();D.close()}else{Logger.error('Could not route directions from "'+Q+'" to "'+V+'", got result from Google: '+Z);P.html("<span style='font-size: 12px; font-weight: bold; color: red'>Could not route directions from<br />'"+Q+"' to<br />'"+V+"'<br />Got result from Google: ["+Z+"]</span>");jQueryCgmp(O+" button#print_sub").hide();jQueryCgmp(O+" button#d_sub").removeAttr("disabled").html("Get directions")}})}});jQueryCgmp(O+" button#print_sub").live("click",function(){var T=jQueryCgmp(O+" input#a_address").val();var R=jQueryCgmp(O+" input#b_address").val();var S="d";if(jQueryCgmp(O+" a#dir_w_btn").hasClass("selected")){S="w"}var Q="http://maps.google.com/?saddr="+T+"&daddr="+R+"&dirflg="+S+"&pw=2";var U=jQueryCgmp(O+" input#radio_miles").is(":checked");if(U){Q+="&doflg=ptm"}window.open(Q);return false});jQueryCgmp(O+" input#a_address").live("change",function(){jQueryCgmp(O+" input#a_address").removeClass("d_error");return false});jQueryCgmp(O+" input#b_address").live("change",function(){jQueryCgmp(O+" input#b_address").removeClass("d_error");return false});jQueryCgmp(O+" input#a_address").live("focus",function(){jQueryCgmp(O+" input#a_address").removeClass("d_error");return false});jQueryCgmp(O+" input#b_address").live("focus",function(){jQueryCgmp(O+" input#b_address").removeClass("d_error");return false});jQueryCgmp(O+" .kd-button").live("click",function(){var Q=this.id;if(Q=="dir_d_btn"){if(jQueryCgmp(O+" a#dir_d_btn").hasClass("selected")){Logger.warn("Driving travel mode is already selected")}else{jQueryCgmp(O+" a#dir_d_btn").addClass("selected");jQueryCgmp(O+" a#dir_w_btn").removeClass("selected")}}else{if(Q=="dir_w_btn"){if(jQueryCgmp(O+" a#dir_w_btn").hasClass("selected")){Logger.warn("Walking travel mode is already selected")}else{jQueryCgmp(O+" a#dir_w_btn").addClass("selected");jQueryCgmp(O+" a#dir_d_btn").removeClass("selected")}}}return false})}function e(T,P){var S=[];var Q=Math.floor(Math.random()*111111);Q=Q+"-"+w;var O="<div id='bubble-"+Q+"' style='height: 130px !important; width: 300px !important;' class='bubble-content'>";if(!P.geoMashup){O+="<h4>Address:</h4>";O+="<p style='text-align: left'>"+T+"</p>"}else{var R=P.postTitle.substring(0,32);O+="<h4>Original Post:</h4>";O+="<p style='text-align: left'><a style='font-size: 14px !important; font-weight: bold !important;' href='"+P.postLink+"'>"+R+"..</a></p>";O+="<p style='font-size: 12px !important; padding-left: 12px !important; padding-right: 6px !important; text-align: left; line-height: 130% !important'>"+P.postExcerpt+"</p>"}O+="<hr />";O+="<p style='text-align: left'>Directions: <a id='toHere-"+Q+"' class='dirToHereTrigger' href='javascript:void(0);'>To here</a> - <a id='fromHere-"+Q+"' class='dirFromHereTrigger' href='javascript:void(0);'>From here</a> | <a id='trigger-"+Q+"' class='streetViewTrigger' href='javascript:void(0);'>Street View</a></p>";O+="</div>";return{bubbleHolderId:Q,bubbleContent:O}}function k(){g=g.replace(new RegExp("'","g"),"");var O=g.split("|");Logger.info("Exploded CSV into locations: "+O);for(var P=0;P<O.length;P++){var Q=O[P];if(Q!=null&&Q!=""){Q=Q.replace(/^\s+|\s+$/g,"");if(Q==""){Logger.warn("Given extra marker address is empty");continue}c(Q,(P+1))}}}function a(P,Q){var O=1;jQueryCgmp.each(P,function(){Logger.info("Looping over JSON object:\n\tTitle: "+this.title+"\n\tAddy: "+this.addy+"\n\tLink: "+this.permalink+"\n\tExcerpt: "+this.excerpt);var R=this.addy.split(CGMPGlobal.sep);if(N.isNumeric(R[0])){i(R[0],O,R[1],this.title,this.permalink,this.excerpt,Q)}else{if(N.isAlphaNumeric(R[0])){J(R[0],O,R[1],this.title,this.permalink,this.excerpt,Q)}else{J(R[0],O,R[1],this.title,this.permalink,this.excerpt,Q);Logger.warn("Unknown type of geo destination in regexp: "+R[0]+", fallingback to store it as an address")}}O++})}function c(Q,O){var P=Q.split(CGMPGlobal.sep);if(N.isNumeric(P[0])){i(P[0],O,P[1],"","","",false)}else{if(N.isAlphaNumeric(P[0])){J(P[0],O,P[1],"","","",false)}else{J(P[0],O,P[1],"","","",false);Logger.warn("Unknown type of geo destination in regexp: "+P[0]+", fallingback to store it as an address")}}}function J(Q,U,P,T,O,S,R){Logger.info("Storing address: "+Q+" for marker-to-be for the map ID: "+w);C.push({address:Q,animation:google.maps.Animation.DROP,zIndex:U,markerIcon:P,postTitle:T,postLink:O,postExcerpt:S,geoMashup:R})}function i(W,V,R,Y,Q,P,X){if(W==null||!W){Logger.warn("Given GEO point containing Lat/Long is NULL");return false}var O=W;if(!(O instanceof google.maps.LatLng)){if(W.indexOf(",")!=-1){var U=W.split(",",4);if(U==null||U.length!=2){Logger.warn("Exploded lat/long array is NULL or does not have length of two");return false}if(U[0]==null||U[1]==null){Logger.warn("Lat or Long are NULL");return false}U[0]=U[0].replace(/^\s\s*/,"").replace(/\s\s*$/,"");U[1]=U[1].replace(/^\s\s*/,"").replace(/\s\s*$/,"");if(U[0]==""||U[1]==""){Logger.warn("Lat or Long are empty string");return false}var S=parseFloat(U[0]);var T=parseFloat(U[1]);O=new google.maps.LatLng(S,T)}}J(O,V,R,Y,Q,P,X)}this.buildAddressMarkers=function(R,O,Q){q=true;if(O=="true"){R=R.replace(/^\s\s*/,"").replace(/\s\s*$/,"");var P=jQueryCgmp.parseJSON(R);if(Q=="true"){a(P,true)}else{if(Q=="false"){a(P,false)}}F()}else{if(O=="false"){g=R;k();F()}}};this.shiftMapToOriginalZoomAndLocation=function(){E()};function F(){H=null;if(C.length>0){var P=C.shift();Logger.info("Passing ["+P.address+"] to Geo service. Have left "+C.length+" items to process!");if(P.address instanceof google.maps.LatLng){K(P)}else{var O={address:P.address};m.geocode(O,function(S,R){o(S,R,P)})}}else{n();if(z.length>0){var Q="";jQueryCgmp.each(z,function(S,R){Q+="\t"+(1+S)+". "+R+"\n"});alert("ATTENTION!\nGoogle could not match given address(es):\n\n"+Q+"\nConsider revising the address(es), alternatively use Google web to validate the address(es) ")}z=[]}}function n(){if(M.length>1){jQueryCgmp.each(M,function(P,O){if(!B.contains(O.position)){B.extend(O.position)}});r=B;f.fitBounds(B);l=f.getZoom()}else{if(M.length==1){f.setCenter(M[0].position);l=f.getZoom()}}}function K(P){var O=P.address;P.address=x(P,O);I(O,P);H=setTimeout(function(){F()},330)}function x(Q,P){if(Q.zIndex==1){h=P}var R=P.lat();R=parseFloat(R);R=R.toFixed(5);var O=P.lng();O=parseFloat(O);O=O.toFixed(5);return"Lat/Long: "+R+", "+O}function o(R,O,Q){if(O==google.maps.GeocoderStatus.OK){var P=R[0].geometry.location;Q.address=R[0].formatted_address+"<br />"+x(Q,P);I(P,Q);H=setTimeout(function(){F()},330)}else{if(O==google.maps.GeocoderStatus.OVER_QUERY_LIMIT){n();C.push(Q);H=setTimeout(function(){F()},3000)}else{if(O==google.maps.GeocoderStatus.ZERO_RESULTS){Logger.warn("Got ZERO results for ["+Q.address+"]. Have left "+M.length+" items to process");z.push(Q.address);H=setTimeout(function(){F()},400)}}}}this.isBuildAddressMarkersCalled=function(){return q};function I(P,S){var Q=new google.maps.Marker({position:P,title:S.address.replace("<br />"," :: "),content:S.address,zIndex:(S.zIndex+1000),map:f});if(Q){if(S.markerIcon){var O=S.markerIcon;Q.setIcon(CGMPGlobal.customMarkersUri+O);var V=null;var T=["1-default.png","2-default.png"];var R=["4-default.png","5-default.png","6-default.png","7-default.png"];if(jQueryCgmp.inArray(O,T)!=-1){V=new google.maps.MarkerImage("http://maps.google.com/mapfiles/ms/icons/msmarker.shadow.png",new google.maps.Size(59,32),new google.maps.Point(0,0),new google.maps.Point(16,33))}else{if(jQueryCgmp.inArray(O,R)!=-1){V=new google.maps.MarkerImage("http://maps.google.com/mapfiles/ms/icons/msmarker.shadow.png",new google.maps.Size(59,32),new google.maps.Point(0,0),new google.maps.Point(21,34))}else{if(O.indexOf("3-default")!=-1){V=new google.maps.MarkerImage("http://code.google.com/apis/maps/documentation/javascript/examples/images/beachflag_shadow.png",new google.maps.Size(37,32),new google.maps.Point(0,0),new google.maps.Point(10,33))}else{V=new google.maps.MarkerImage(CGMPGlobal.customMarkersUri+"shadow.png",new google.maps.Size(68,37),new google.maps.Point(0,0),new google.maps.Point(32,38))}}}var U=V.url.split("/");Q.setShadow(V)}if(S.zIndex==0&&S.animation==google.maps.Animation.BOUNCE){Q.setAnimation(google.maps.Animation.BOUNCE)}b(Q,S);if(!L){j();L=true}M.push(Q)}}};jQueryCgmp.OrchestratorHub=function(){jQueryCgmp.extend(this,jQueryCgmp.OrchestratorHub.defaultOptions);var a=[];this.getOrcs=function(){return a};this.push=function(b){a.push(b)};this.getOrc=function(b){var c={};jQueryCgmp.map(jQueryCgmp(a),function(d){if(d.mapId==b){c=d.orchestrator}});return c}};var Logger={info:function(a){var b="Info :: "+a;this.print(b)},raw:function(a){this.print(a)},warn:function(a){var b="Warning :: "+a;this.print(b)},error:function(a){var b="Error :: "+a;this.print(b)},fatal:function(a){var b="Fatal :: "+a;this.print(b)},print:function(a){if(jQueryCgmp.browser.msie){}else{if(jQueryCgmp.browser.mozilla&&jQueryCgmp.browser.version>="3.0"){console.log(a)}}}};var orcHolder=new jQueryCgmp.OrchestratorHub();