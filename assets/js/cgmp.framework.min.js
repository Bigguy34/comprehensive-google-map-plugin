(function(){("undefined"==typeof jQuery||null==jQuery)&&alert("You dont have jQuery library loaded, aborting map generation :(")})();
(function(a){var h,m,E,F,t=function(){e.fatal("Using parseJson stub..")};1.4<=parseFloat(a.fn.jquery)?t=a.parseJSON:window.JSON&&window.JSON.parse&&(t=window.JSON.parse);h=void 0;m=void 0;E=void 0;F=void 0;var z=function(){var a={};return{initMap:function(c,b,e,j){a=c;var c=[],G;for(G in google.maps.MapTypeId)c.push(google.maps.MapTypeId[G]);"OSM"==j?(c.push(j),a.mapTypes.set(j,new google.maps.ImageMapType({getTileUrl:function(a,b){return"http://tile.openstreetmap.org/"+b+"/"+a.x+"/"+a.y+".png"},
tileSize:new google.maps.Size(256,256),name:"OpenStreet",maxZoom:20}))):"ROADMAP"==j?j=google.maps.MapTypeId.ROADMAP:"SATELLITE"==j?j=google.maps.MapTypeId.SATELLITE:"HYBRID"==j?j=google.maps.MapTypeId.HYBRID:"TERRAIN"==j&&(j=google.maps.MapTypeId.TERRAIN);a.setOptions({zoom:e,mapTypeId:j,mapTypeControlOptions:{mapTypeIds:c}})},setMapControls:function(c){a.setOptions(c)}}}(),o=function(){var a={};return{init:function(c){a=c},buildKmlLayer:function(c){if(0>c.toLowerCase().indexOf("http"))return e.error("KML URL must start with HTTP(S). Aborting.."),
!1;var b=new google.maps.KmlLayer(c);google.maps.event.addListener(b,"status_changed",function(){var a=b.getStatus();if(a!=google.maps.KmlLayerStatus.OK){var c="";switch(a){case google.maps.KmlLayerStatus.DOCUMENT_NOT_FOUND:c=h.kmlNotFound;break;case google.maps.KmlLayerStatus.DOCUMENT_TOO_LARGE:c=h.kmlTooLarge;break;case google.maps.KmlLayerStatus.FETCH_ERROR:c=h.kmlFetchError;break;case google.maps.KmlLayerStatus.INVALID_DOCUMENT:c=h.kmlDocInvalid;break;case google.maps.KmlLayerStatus.INVALID_REQUEST:c=
h.kmlRequestInvalid;break;case google.maps.KmlLayerStatus.LIMITS_EXCEEDED:c=h.kmlLimits;break;case google.maps.KmlLayerStatus.TIMED_OUT:c=h.kmlTimedOut;break;case google.maps.KmlLayerStatus.UNKNOWN:c=h.kmlUnknown}if(""!=c){var g=h.kml.replace("[MSG]",c),g=g.replace("[STATUS]",a);A.alertError(g);e.error("Google returned KML error: "+c+" ("+a+")");e.error("KML file: "+b.getUrl())}}});b.setMap(a)},buildTrafficLayer:function(){(new google.maps.TrafficLayer).setMap(a)},buildBikeLayer:function(){(new google.maps.BicyclingLayer).setMap(a)},
buildPanoramioLayer:function(c){if("undefined"==typeof google.maps.panoramio||!google.maps.panoramio||null==google.maps.panoramio)return e.error("We cannot access Panoramio library. Aborting.."),!1;var b=new google.maps.panoramio.PanoramioLayer;b?(null!=c&&""!=c&&b.setUserId(c),b.setMap(a)):e.error("Could not instantiate Panoramio object. Aborting..")}}}(),L=function(){function g(){null!=q?l.getCenter()!=q.getCenter()&&(e.info("Panning map back to its original bounds center: "+q.getCenter()),l.fitBounds(q),
l.setCenter(q.getCenter())):null!=B&&(e.info("Panning map back to its original center: "+B+" and updated zoom: "+H),l.setCenter(B),l.setZoom(H))}function c(d){a(d+" input#a_address").val("");a(d+" input#b_address").val("");a(d+" input#a_address").removeClass("d_error");a(d+" input#b_address").removeClass("d_error")}function b(d,i){var k=U(d.content,i),f="div#direction-controls-placeholder-"+p,b=a("div#rendered-directions-placeholder-"+p);google.maps.event.addListener(d,"click",function(){c(f);a(f).fadeOut();
u.setMap(null);b.html("");b.hide();a(f+" button#print_sub").hide();r.setContent(k.bubbleContent);r.setOptions({disableAutoPan:"true"==N?!1:!0});r.open(l,this)});j(d,k,f);T(d,k,f,b)}function T(d,i,k,f){var b="div#bubble-"+i.bubbleHolderId,e=d.content,e=e.replace("Lat/Long: ","");a(b+" a.dirToHereTrigger").live("click",function(){this.id=="toHere-"+i.bubbleHolderId&&(a(k).fadeIn(),a(k+" input#a_address").val(""),a(k+" input#b_address").val(e),a(k+" input#radio_miles").attr("checked","checked"))});a(b+
" a.dirFromHereTrigger").live("click",function(){this.id=="fromHere-"+i.bubbleHolderId&&(a(k).fadeIn(),a(k+" input#a_address").val(e),a(k+" input#b_address").val(""),a(k+" input#radio_miles").attr("checked","checked"))});a(k+" div.d_close-wrapper").live("click",function(){c(k);a(this).parent().fadeOut();u.setMap(null);f.html("");f.hide();a(k+" button#print_sub").hide();g();return!1})}function j(d,i,k){O.getPanoramaByLocation(d.position,50,function(f,b){b===google.maps.StreetViewStatus.OK?a("a#trigger-"+
i.bubbleHolderId).live("click",function(){var f={navigationControl:!0,enableCloseButton:!0,addressControl:!1,linksControl:!0,scrollwheel:!1,addressControlOptions:{position:google.maps.ControlPosition.BOTTOM},position:d.position,pov:{heading:165,pitch:0,zoom:1}},b=new google.maps.StreetViewPanorama(document.getElementById("bubble-"+i.bubbleHolderId),f);b.setVisible(!0);google.maps.event.addListener(r,"closeclick",function(){c(k);a(k).fadeOut();null!=b&&(b.unbind("position"),b.setVisible(!1));b=null});
google.maps.event.addListener(b,"closeclick",function(){null!=b&&(b.unbind("position"),b.setVisible(!1),a("div#bubble-"+i.bubbleHolderId).css("background","none"));b=null})}):(e.warn("There is not street view available for this marker location: "+d.position+" status: "+b),a("a#trigger-"+i.bubbleHolderId).live("click",function(a){a.preventDefault()}),a("a#trigger-"+i.bubbleHolderId).attr("style","text-decoration: none !important; color: #ddd !important"),google.maps.event.addListener(r,"domready",
function(){a("a#trigger-"+i.bubbleHolderId).removeAttr("href");a("a#trigger-"+i.bubbleHolderId).attr("style","text-decoration: none !important; color: #ddd !important")}))})}function G(){var d="div#direction-controls-placeholder-"+p,i=a("div#rendered-directions-placeholder-"+p);a(d+" a#reverse-btn").live("click",function(){var i=a(d+" input#a_address").val(),b=a(d+" input#b_address").val();a(d+" input#a_address").val(b);a(d+" input#b_address").val(i);return!1});a(d+" a#d_options_show").live("click",
function(){a(d+" a#d_options_hide").show();a(d+" a#d_options_show").hide();a(d+" div#d_options").show();return!1});a(d+" a#d_options_hide").live("click",function(){a(d+" a#d_options_hide").hide();a(d+" a#d_options_show").show();a(d+" div#d_options").hide();a(d+" input#avoid_hway").removeAttr("checked");a(d+" input#avoid_tolls").removeAttr("checked");a(d+" input#radio_km").removeAttr("checked");a(d+" input#radio_miles").attr("checked","checked");return!1});a(d+" button#d_sub").live("click",function(){var b=
a(d+" input#a_address").val(),f=a(d+" input#b_address").val(),c=!1;if(null==b||""==b)a(d+" input#a_address").addClass("d_error"),c=!0;if(null==f||""==f)a(d+" input#b_address").addClass("d_error"),c=!0;if(!c){a(d+" button#d_sub").attr("disabled","disabled").html("Please wait..");var g=google.maps.DirectionsTravelMode.DRIVING;a(d+" a#dir_w_btn").hasClass("selected")&&(g=google.maps.DirectionsTravelMode.WALKING);var c=a(d+" input#avoid_hway").is(":checked"),j=a(d+" input#avoid_tolls").is(":checked"),
h=a(d+" input#radio_miles").is(":checked"),g={origin:b,destination:f,travelMode:g,provideRouteAlternatives:!0};c&&(g.avoidHighways=!0);j&&(g.avoidTolls=!0);g.unitSystem=h?google.maps.DirectionsUnitSystem.IMPERIAL:google.maps.DirectionsUnitSystem.METRIC;P.route(g,function(c,g){g==google.maps.DirectionsStatus.OK?(i.html(""),i.show(),u.setMap(l),u.setDirections(c),a(d+" button#d_sub").removeAttr("disabled").html("Get directions"),a(d+" button#print_sub").fadeIn(),r.close()):(e.error('Could not route directions from "'+
b+'" to "'+f+'", got result from Google: '+g),i.html("<span style='font-size: 12px; font-weight: bold; color: red'>Could not route directions from<br />'"+b+"' to<br />'"+f+"'<br />Got result from Google: ["+g+"]</span>"),a(d+" button#print_sub").hide(),a(d+" button#d_sub").removeAttr("disabled").html("Get directions"))})}});a(d+" button#print_sub").live("click",function(){var b=a(d+" input#a_address").val(),i=a(d+" input#b_address").val(),c="d";a(d+" a#dir_w_btn").hasClass("selected")&&(c="w");b=
"http://maps.google.com/?saddr="+b+"&daddr="+i+"&dirflg="+c+"&pw=2";a(d+" input#radio_miles").is(":checked")&&(b+="&doflg=ptm");window.open(b);return!1});a(d+" input#a_address").live("change focus",function(){a(d+" input#a_address").removeClass("d_error");return!1});a(d+" input#b_address").live("change focus",function(){a(d+" input#b_address").removeClass("d_error");return!1});a(d+" .kd-button").live("click",function(){var b=this.id;"dir_d_btn"==b?a(d+" a#dir_d_btn").hasClass("selected")?e.warn("Driving travel mode is already selected"):
(a(d+" a#dir_d_btn").addClass("selected"),a(d+" a#dir_w_btn").removeClass("selected")):"dir_w_btn"==b&&(a(d+" a#dir_w_btn").hasClass("selected")?e.warn("Walking travel mode is already selected"):(a(d+" a#dir_w_btn").addClass("selected"),a(d+" a#dir_d_btn").removeClass("selected")));return!1})}function U(a,b){var c=Math.floor(111111*Math.random()),c=c+"-"+p,f="<div id='bubble-"+c+"' style='height: 130px !important; width: 300px !important;' class='bubble-content'>";if(b.geoMashup)var g=b.postTitle.substring(0,
30),f=f+""+("<p style='text-align: left'><a style='font-size: 15px !important; font-weight: bold !important;' title='Original post: "+b.postTitle+"' href='"+b.postLink+"'>"+g+"..</a></p>"),f=f+("<p style='font-size: 12px !important; padding-left: 12px !important; padding-right: 6px !important; text-align: left; line-height: 130% !important'>"+b.postExcerpt+"</p>");else f+="<h4>"+m.address+":</h4>",f+="<p style='text-align: left'>"+a+"</p>",""!=b.customBubbleText&&(f+="<p style='text-align: left; margin-top: 5px !important;'>"+
b.customBubbleText+"</p>");f=f+"<hr />"+("<p style='text-align: left'>"+m.directions+": <a id='toHere-"+c+"' class='dirToHereTrigger' href='javascript:void(0);'>"+m.toHere+"</a> - <a id='fromHere-"+c+"' class='dirFromHereTrigger' href='javascript:void(0);'>"+m.fromHere+"</a> | <a id='trigger-"+c+"' class='streetViewTrigger' href='javascript:void(0);'>"+m.streetView+"</a></p>");return{bubbleHolderId:c,bubbleContent:f+"</div>"}}function M(b,i){var c=1;a.each(b,function(){null==this.excerpt&&(this.excerpt=
"");e.info("Looping over JSON object:\n\tTitle: "+this.title+"\n\tAddy: "+this.addy+"\n\tLink: "+this.permalink+"\n\tExcerpt: "+this.excerpt);var a=this.addy.split(E);n.isNumeric(a[0])?z(c,a,this.title,this.permalink,this.excerpt,i):n.isAlphaNumeric(a[0])?o(c,a,this.title,this.permalink,this.excerpt,i):(o(c,a,this.title,this.permalink,this.excerpt,i),e.warn("Unknown type of geo destination in regexp: "+a[0]+", fallingback to store it as an address"));c++})}function o(a,b,c,f,g,j){null!=b[2]?-1!=b[2].indexOf("No description provided")&&
(b[2]=""):b[2]="";e.info("Storing address: "+b[0]+" for marker-to-be for the map ID: "+p);v.push({address:b[0],animation:google.maps.Animation.DROP,zIndex:a,markerIcon:b[1],customBubbleText:b[2],postTitle:c,postLink:f,postExcerpt:g,geoMashup:j})}function z(a,b,c,f,g,j){var h=[];-1!=b[0].indexOf(",")?h=b[0].split(","):-1!=b[0].indexOf(";")&&(h=b[0].split(";"));if(0==h.length)return e.warn("Exploded lat/long array has length of zero"),!1;h[0]=n.trim(h[0]);h[1]=n.trim(h[1]);if(""==h[0]||""==h[1])return e.warn("Lat or Long are empty string"),
!1;b[0]=new google.maps.LatLng(parseFloat(h[0]),parseFloat(h[1]));o(a,b,c,f,g,j)}function w(){clearTimeout(C);if(0<v.length){var b=v.shift();e.info("Passing ["+b.address+"] to Geo service. Have left "+v.length+" items to process!");b.address instanceof google.maps.LatLng?L(b):Q.geocode({address:b.address},function(a,c){V(a,c,b)})}else{R();if(0<D.length){var c="";a.each(D,function(a,b){c+="&nbsp;&nbsp;&nbsp;<b>"+(1+a)+". "+b+"</b><br />"});A.alertError(h.badAddresses.replace("[REPLACE]",c))}D=[]}}
function R(){1<s.length?(a.each(s,function(a,b){x.contains(b.position)||x.extend(b.position)}),q=x,null!=x&&l.fitBounds(x)):1==s.length&&(l.setCenter(s[0].position),H=l.getZoom(),B=l.getCenter())}function L(a){var b=a.address;a.address="Lat/Long: "+b.lat().toFixed(6)+", "+b.lng().toFixed(6);S(b,a);w()}function V(a,b,c){b==google.maps.GeocoderStatus.OK?(S(a[0].geometry.location,c),C=setTimeout(function(){w()},330)):b==google.maps.GeocoderStatus.OVER_QUERY_LIMIT?(R(),v.push(c),C=setTimeout(function(){w()},
3E3)):b==google.maps.GeocoderStatus.ZERO_RESULTS&&(e.warn("Got ZERO results for ["+c.address+"]. Have left "+s.length+" items to process"),D.push(c.address),C=setTimeout(function(){w()},400))}function S(c,g){var e=new google.maps.Marker({position:c,title:g.address.replace("<br />"," :: "),content:g.address,zIndex:g.zIndex+1E3,map:l});if(e){if(g.markerIcon){var f=g.markerIcon;e.setIcon(F+f);var h=null,h=["4-default.png","5-default.png","6-default.png","7-default.png"],h=-1!=a.inArray(f,["1-default.png",
"2-default.png"])?I("http://maps.google.com/mapfiles/ms/icons/msmarker.shadow.png",59,32,0,0,16,33):-1!=a.inArray(f,h)?I("http://maps.google.com/mapfiles/ms/icons/msmarker.shadow.png",59,32,0,0,21,34):-1!=f.indexOf("3-default")?I("http://code.google.com/apis/maps/documentation/javascript/examples/images/beachflag_shadow.png",37,32,0,0,10,33):I(F+"shadow.png",68,37,0,0,32,38);e.setShadow(h)}b(e,g);J||(G(),J=!0);s.push(e)}}function I(a,b,c,f,g,e,h){return new google.maps.MarkerImage(a,new google.maps.Size(b,
c),new google.maps.Point(f,g),new google.maps.Point(e,h))}var s,v,D,K,C,J,l,y,N,q,B,H,p,Q,x,r,O,u,P;return{init:function(a,b){l=a;p=l.getDiv().id;N=b;google.maps.event.addListener(l,"click",function(){g()});s=[];D=[];v=[];H=5;q=B=y=C=null;K=J=!1;Q=new google.maps.Geocoder;x=new google.maps.LatLngBounds;r=new google.maps.InfoWindow;O=new google.maps.StreetViewService;P=new google.maps.DirectionsService;rendererOptions={draggable:!0};u=new google.maps.DirectionsRenderer(rendererOptions);u.setPanel(document.getElementById("rendered-directions-placeholder-"+
p))},buildAddressMarkers:function(a,b,c){K=!0;y=n.trim(a);y=n.searchReplace(y,"'","");if("true"==b)a=t(y),"true"==c?M(a,!0):"false"==c&&M(a,!1),w();else if("false"==b){c=y.split("|");e.info("Exploded CSV into locations: "+c);for(a=0;a<c.length;a++){var f=c[a];null!=f&&""!=f&&(f=n.trim(f),""==f?e.warn("Given extra marker address is empty"):(b=a+1,f=f.split(E),n.isNumeric(f[0])?z(b,f,"","","",!1):n.isAlphaNumeric(f[0])?o(b,f,"","","",!1):(o(b,f,"","","",!1),e.warn("Unknown type of geo destination in regexp: "+
f[0]+", fallingback to store it as an address"))))}w()}},isBuildAddressMarkersCalled:function(){return K}}},n=function(){return{isNumeric:function(a){return/^([0-9?(\-.,;\s{1,})]+)$/.test(a)},isAlphaNumeric:function(a){return/^([a-zA-Z0-9?(/\-.,\s{1,})]+)$/.test(a)},trim:function(a){return a.replace(/^\s+|\s+$/g,"")},searchReplace:function(a,c,b){return a.replace(RegExp(c,"g"),b)}}}(),e=function(){var g=function(c){a.browser.msie||(a.browser.mozilla&&3<=parseInt(a.browser.version)?console.log(c):
a.browser.webkit?console.log(c):console.log("Logger could not print because browser is not webkit nor mozilla, and its version is ["+parseInt(a.browser.version)+"]"))};return{info:function(a){g("Info :: "+a)},raw:function(a){g(a)},warn:function(a){g("Warning :: "+a)},error:function(a){g("Error :: "+a)},fatal:function(a){g("Fatal :: "+a)}}}(),A=function(){return{alertError:function(g){function c(b,c){b.preventDefault();var e=a(c).closest("div.cgmp-popup-shortcode-dialog");e&&a(e).remove();0==a("div.cgmp-popup-shortcode-dialog").length&&
a("#cgmp-popup-mask").remove()}var b=a('<div id="cgmp-popup-mask"/>'),e=Math.random().toString(36).substring(3),h=a('<div id="'+e+'" class="cgmp-popup-shortcode-dialog cgmp-popup-window">');h.html("<div class='dismiss-container'><a class='dialog-dismiss' href='javascript:void(0)'>\u00d7</a></div><p style='padding: 10px 10px 0 10px'>"+g+"</p><div align='center'><input type='button' class='close-dialog' value='Close' /></div>");a("body").append(b);a("body").append(h);g=a(document).height();b=a(window).width();
a("#cgmp-popup-mask").css({width:b,height:g,opacity:0.1});1==a("#cgmp-popup-mask").length&&a("#cgmp-popup-mask").show();g=a(window).height();b=a(window).width();a("div#"+e).css("top",g/2-a("div#"+e).height()/2);a("div#"+e).css("left",b/2-a("div#"+e).width()/2);a("div#"+e).fadeIn(500);a(".cgmp-popup-window .close-dialog").click(function(b){c(b,a(this))});a(".cgmp-popup-window .dialog-dismiss").click(function(b){c(b,a(this))});a("#cgmp-popup-mask").click(function(){a(this).remove();a(".cgmp-popup-window").remove()});
a(window).resize(function(){var b=a(".window"),c=a(document).height(),e=a(window).width();a("#cgmp-popup-mask").css({width:e,height:c});c=a(window).height();e=a(window).width();b.css("top",c/2-b.height()/2);b.css("left",e/2-b.width()/2)})}}}();0==a("object#global-data-placeholder").length?e.fatal("The global HTML <object> element is undefined. Aborting map generation .. d[-_-]b"):(E=a("object#global-data-placeholder").find("param#sep").val(),F=a("object#global-data-placeholder").find("param#customMarkersUri").val(),
h=a("object#global-data-placeholder").find("param#errors").val(),h=t(h),m=a("object#global-data-placeholder").find("param#translations").val(),m=t(m),a("object.map-data-placeholder").each(function(g,c){if("undefined"==typeof google||!google)return A.alertError(h.msgNoGoogle),e.fatal("We do not have reference to Google API. Aborting map generation .."),!1;if("undefined"!=typeof GMap2&&GMap2)return A.alertError(h.msgApiV2),e.fatal("It looks like the webpage has reference to GMap2 object from Google API v2. Aborting map generation .."),
!1;var b=a(c).attr("id"),b=a(c).find("param#json-string-"+b).val(),b=n.searchReplace(b,"'",""),b=t(b);if("undefined"==typeof b||!b)return e.fatal("We did not parse JSON from OBJECT param. Aborting map generation .."),!1;if(0<a("div#"+b.id).length){var m=new google.maps.Map(document.getElementById(b.id));z.initMap(m,b.bubbleautopan,parseInt(b.zoom),b.maptype);o.init(m);var j=new L;j.init(m,b.bubbleautopan);z.setMapControls({mapTypeControl:"true"===b.maptypecontrol,panControl:"true"===b.pancontrol,
zoomControl:"true"===b.zoomcontrol,scaleControl:"true"===b.scalecontrol,scrollwheel:"true"===b.scrollwheelcontrol,streetViewControl:"true"===b.streetviewcontrol});"true"===b.showpanoramio&&o.buildPanoramioLayer(b.panoramiouid);"true"===b.showbike&&o.buildBikeLayer();"true"===b.showtraffic&&o.buildTrafficLayer();null!=b.kml&&""!=n.trim(b.kml)?o.buildKmlLayer(b.kml):(null!=b.markerlist&&""!=n.trim(b.markerlist)&&j.buildAddressMarkers(b.markerlist,b.addmarkermashup,b.addmarkermashupbubble),j.isBuildAddressMarkersCalled()||
A.alertError(h.msgMissingMarkers))}else e.fatal("It looks like the map DIV placeholder ID ["+b.id+"] does not exist in the page!")}))})(jQuery);
